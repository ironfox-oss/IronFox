From 99c7f87be39d1ba6d17fed0c48e7c7bba41318f1 Mon Sep 17 00:00:00 2001
From: celenity <celenity@celenity.dev>
Date: Tue, 17 Feb 2026 04:54:19 +0000
Subject: [PATCH] feat: add support for IronFox onboarding cards

Signed-off-by: celenity <celenity@celenity.dev>
---
 mobile/android/fenix/app/onboarding.fml.yaml  | 80 +++++++++++++++++++
 .../org/mozilla/fenix/FenixApplication.kt     |  1 +
 .../fenix/onboarding/OnboardingFragment.kt    |  3 +
 .../redesign/view/OnboardingScreenRedesign.kt | 14 ++++
 .../fenix/onboarding/view/OnboardingMapper.kt | 40 ++++++++++
 .../onboarding/view/OnboardingPageState.kt    | 17 ++++
 .../onboarding/view/OnboardingPageUiData.kt   |  7 ++
 .../fenix/onboarding/view/OnboardingScreen.kt | 20 +++++
 .../settings/doh/root/DohSettingsScreen.kt    |  2 +-
 9 files changed, 183 insertions(+), 1 deletion(-)

diff --git a/mobile/android/fenix/app/onboarding.fml.yaml b/mobile/android/fenix/app/onboarding.fml.yaml
index 77ce1334c2bf..277881292e03 100644
--- a/mobile/android/fenix/app/onboarding.fml.yaml
+++ b/mobile/android/fenix/app/onboarding.fml.yaml
@@ -124,6 +124,43 @@ features:
                   body-line-one-text: onboarding_marketing_learn_more
                   body-line-one-link-text: onboarding_marketing_learn_more
                   body-line-two-text: onboarding_marketing_opt_out_checkbox
+
+            if-preference-doh:
+              card-type: if-preference-doh
+              enabled: true
+              title: onboarding_if_preferences_title
+              body: onboarding_if_preference_doh_caption
+              image-res: ic_launcher_foreground
+              ordering: 10000
+              primary-button-label: onboarding_save_and_continue_button
+
+            if-preferences:
+              card-type: if-preferences
+              enabled: true
+              title: onboarding_if_preferences_title
+              body: onboarding_if_preferences_description
+              image-res: ic_launcher_foreground
+              ordering: 10005
+              primary-button-label: onboarding_save_and_start_button
+              extra-data:
+                if-preferences-data:
+                  - switch-type: js-jit
+                    switch-label: preference_jit_enabled
+                    switch-caption: preference_jit_enabled_caption
+                    switch-description: preference_jit_enabled_description
+                  - switch-type: safe-browsing
+                    switch-label: preference_safe_browsing_enabled
+                    switch-caption: preference_safe_browsing_enabled_caption
+                    switch-description: preference_safe_browsing_enabled_description
+                  - switch-type: spoof-english
+                    switch-label: tor_spoof_english_title
+                    switch-caption: tor_spoof_english_caption
+                    switch-description: tor_spoof_english_description
+                  - switch-type: install-ublock
+                    switch-label: onboarding_install_ublock_title
+                    switch-caption: onboarding_install_ublock_caption
+                    switch-description: onboarding_install_ublock_description
+
     defaults:
       - channel: developer
         value:
@@ -468,6 +505,11 @@ objects:
         description: >
           An optional marketing data for the onboarding card.
         default: null
+      if-preferences-data:
+        type: List<IfPreferencesData>
+        description: >
+          A list of preferences for the IronFox preferences onboarding card.
+        default: [ ]
 
   CustomizationToolbarData:
     description: An object to describe the placement of the toolbar.
@@ -579,6 +621,26 @@ objects:
         description: The text for line two of the body.
         default: ""
 
+  IfPreferencesData:
+    description: An object to describe the IronFox preferences onboarding card.
+    fields:
+      switch-label:
+        type: Text
+        description: The text for the preference switch.
+        default: ""
+      switch-caption:
+        type: Text
+        description: The text for the brief caption of the switch.
+        default: ""
+      switch-description:
+        type: Text
+        description: The text for the long description of the switch.
+        default: ""
+      switch-type:
+        type: IfOnboardingPreferenceType
+        description: The type of preference.
+        default: default
+
 enums:
 
   OnboardingCardType:
@@ -600,6 +662,10 @@ enums:
         description: Page to display the terms of services.
       marketing-data:
         description: Allows user to opt out of marketing data collection.
+      if-preference-doh:
+        description: Allows user to configure DNS-over-HTTPS.
+      if-preferences:
+        description: Allows user to configure IronFox-specific preferences.
 
   ToolbarType:
     description: An enum to describe a toolbar placement option.
@@ -618,3 +684,17 @@ enums:
         description: Sets the theme to light mode.
       theme-dark:
         description: Sets the theme to dark mode.
+
+  IfOnboardingPreferenceType:
+    description: An enum to describe an IronFox preference option.
+    variants:
+      default:
+        description: Default value for preference type. NEVER use this.
+      js-jit:
+        description: Whether to enable JavaScript JIT.
+      safe-browsing:
+        description: Whether to enable safe browsing.
+      spoof-english:
+        description: Whether to request English versions of web pages for enhanced privacy.
+      install-ublock:
+        description: Whether to install uBlock Origin.
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt
index 725fe78ce0cc..d323ea6349e0 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/FenixApplication.kt
@@ -316,6 +316,7 @@ open class FenixApplication : LocaleAwareApplication(), Provider {
         setupLeakCanary()
 
         if (components.fenixOnboarding.userHasBeenOnboarded()) {
+            settings().ironfox.ironFoxOnboardingCompleted = true
             startMetricsIfEnabled(
                 logger = logger,
                 analytics = components.analytics,
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/OnboardingFragment.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/OnboardingFragment.kt
index 947a088c2dc4..3582181ce34c 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/OnboardingFragment.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/OnboardingFragment.kt
@@ -65,6 +65,7 @@ import org.mozilla.fenix.settings.SupportUtils
 import org.mozilla.fenix.theme.FirefoxTheme
 import org.mozilla.fenix.utils.canShowAddSearchWidgetPrompt
 import org.mozilla.fenix.utils.maybeShowAddSearchWidgetPrompt
+import org.ironfoxoss.ironfox.utils.GeckoSettingsBridge
 
 /**
  * Fragment displaying the onboarding flow.
@@ -469,6 +470,8 @@ class OnboardingFragment : Fragment() {
         requireComponents.fenixOnboarding.finish()
 
         val settings = requireContext().settings()
+        settings.ironfox.ironFoxOnboardingCompleted = true
+        GeckoSettingsBridge.setIronFoxPrefs(requireContext(), requireComponents.core.engine)
         viewLifecycleOwner.lifecycleScope.launch {
             initializeGlean(
                 requireContext().applicationContext,
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/redesign/view/OnboardingScreenRedesign.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/redesign/view/OnboardingScreenRedesign.kt
index 9849fb85d5b2..abfede88560e 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/redesign/view/OnboardingScreenRedesign.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/redesign/view/OnboardingScreenRedesign.kt
@@ -239,6 +239,12 @@ fun OnboardingScreenRedesign(
             onMarketingDataContinueClick(allowMarketingDataCollection)
             scrollToNextPageOrDismiss()
         },
+        onIfPreferenceDohButtonClick = {
+            scrollToNextPageOrDismiss()
+        },
+        onIfPreferencesButtonClick = {
+            scrollToNextPageOrDismiss()
+        },
         onboardingStore = onboardingStore,
     )
 }
@@ -285,6 +291,8 @@ private fun OnboardingContent(
     onMarketingOptInToggle: (optIn: Boolean) -> Unit,
     onMarketingDataLearnMoreClick: () -> Unit,
     onMarketingDataContinueClick: (allowMarketingDataCollection: Boolean) -> Unit,
+    onIfPreferenceDohButtonClick: () -> Unit,
+    onIfPreferencesButtonClick: () -> Unit,
 ) {
     BoxWithConstraints(modifier = Modifier.fillMaxSize()) {
         val layout = getOnboardingLayout(this)
@@ -333,6 +341,8 @@ private fun OnboardingContent(
                         onAddFirefoxWidgetSkipClick = onSkipFirefoxWidgetClick,
                         onCustomizeToolbarButtonClick = onCustomizeToolbarButtonClick,
                         onTermsOfServiceButtonClick = onAgreeAndConfirmTermsOfService,
+                        onIfPreferenceDohButtonClick = onIfPreferenceDohButtonClick,
+                        onIfPreferencesButtonClick = onIfPreferencesButtonClick,
                         shouldShowElevation = !layout.isSmall,
                     )
 
@@ -448,6 +458,8 @@ private fun OnboardingPageForType(
 
         // no-ops
         OnboardingPageUiData.Type.THEME_SELECTION,
+        OnboardingPageUiData.Type.IF_PREFERENCE_DOH,
+        OnboardingPageUiData.Type.IF_PREFERENCES,
             -> {
             logger.error("Unsupported page type: $type used for onboarding redesign.")
         }
@@ -618,6 +630,8 @@ private fun OnboardingScreenPreview() {
             onMarketingDataContinueClick = {},
             onNotificationPermissionButtonClick = {},
             onNotificationPermissionSkipClick = {},
+            onIfPreferenceDohButtonClick = {},
+            onIfPreferencesButtonClick = {},
         )
     }
 }
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingMapper.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingMapper.kt
index 421a1d091fdd1..306c920c88a0e 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingMapper.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingMapper.kt
@@ -12,6 +12,9 @@ import org.mozilla.fenix.nimbus.OnboardingCardType
 import org.mozilla.fenix.nimbus.TermsOfServiceData
 import org.mozilla.fenix.nimbus.ThemeType
 import org.mozilla.fenix.nimbus.ToolbarType
+import java.lang.UnsupportedOperationException
+import org.mozilla.fenix.nimbus.IfOnboardingPreferenceType
+import org.mozilla.fenix.nimbus.IfPreferencesData
 
 /**
  * Returns a list of all the required Nimbus 'cards' that have been converted to [OnboardingPageUiData].
@@ -114,6 +117,7 @@ private fun OnboardingCardData.toPageUiData(privacyCaption: Caption?) = Onboardi
         ?.toOnboardingThemeOptions(),
     termsOfService = extraData?.termOfServiceData?.toOnboardingTermsOfService(),
     marketingData = extraData?.marketingData?.toOnboardingMarketingData(),
+    ifPreferencesData = extraData?.ifPreferencesData?.toOnboardingIfPreferenceOptions(),
 )
 
 private fun OnboardingCardType.toPageUiDataType() = when (this) {
@@ -125,6 +129,8 @@ private fun OnboardingCardType.toPageUiDataType() = when (this) {
     OnboardingCardType.THEME_SELECTION -> OnboardingPageUiData.Type.THEME_SELECTION
     OnboardingCardType.TERMS_OF_SERVICE -> OnboardingPageUiData.Type.TERMS_OF_SERVICE
     OnboardingCardType.MARKETING_DATA -> OnboardingPageUiData.Type.MARKETING_DATA
+    OnboardingCardType.IF_PREFERENCE_DOH -> OnboardingPageUiData.Type.IF_PREFERENCE_DOH
+    OnboardingCardType.IF_PREFERENCES -> OnboardingPageUiData.Type.IF_PREFERENCES
 }
 
 private fun List<CustomizationToolbarData>.toOnboardingToolbarOptions() = map { it.toOnboardingCustomizeToolbar() }
@@ -180,6 +186,25 @@ private fun ThemeType.toThemeOptionType() = when (this) {
     ThemeType.THEME_SYSTEM -> ThemeOptionType.THEME_SYSTEM
 }
 
+private fun List<IfPreferencesData>.toOnboardingIfPreferenceOptions() = map { it.toOnboardingThemeOption() }
+
+private fun IfPreferencesData.toOnboardingThemeOption() = with(this) {
+    IfPreferenceOption(
+        label = switchLabel,
+        caption = switchCaption,
+        description = switchDescription,
+        preferenceType = switchType.toIfPreferenceType(),
+    )
+}
+
+private fun IfOnboardingPreferenceType.toIfPreferenceType() = when (this) {
+    IfOnboardingPreferenceType.JS_JIT -> IfPreferenceType.JS_JIT
+    IfOnboardingPreferenceType.SAFE_BROWSING -> IfPreferenceType.SAFE_BROWSING
+    IfOnboardingPreferenceType.SPOOF_ENGLISH -> IfPreferenceType.SPOOF_ENGLISH
+    IfOnboardingPreferenceType.INSTALL_UBLOCK -> IfPreferenceType.INSTALL_UBLOCK
+    IfOnboardingPreferenceType.DEFAULT -> throw UnsupportedOperationException("Unsupported IfOnboardingPreferenceType: default")
+}
+
 /**
  * Mapper to convert [OnboardingPageUiData] to [OnboardingPageState] that is a param for
  * [OnboardingPage] composable.
@@ -199,6 +224,8 @@ internal fun mapToOnboardingPageState(
     onCustomizeToolbarButtonClick: () -> Unit,
     onCustomizeThemeClick: () -> Unit = {},
     onTermsOfServiceButtonClick: () -> Unit,
+    onIfPreferenceDohButtonClick: () -> Unit,
+    onIfPreferencesButtonClick: () -> Unit,
     onMarketingDataContinueClick: () -> Unit = {},
 ): OnboardingPageState = when (onboardingPageUiData.type) {
     OnboardingPageUiData.Type.DEFAULT_BROWSER -> createOnboardingPageState(
@@ -256,6 +283,20 @@ internal fun mapToOnboardingPageState(
         onNegativeButtonClick = {}, // No negative button option for marketing data.
         shouldShowElevation = shouldShowElevation,
     )
+
+    OnboardingPageUiData.Type.IF_PREFERENCE_DOH -> createOnboardingPageState(
+        onboardingPageUiData = onboardingPageUiData,
+        onPositiveButtonClick = onIfPreferenceDohButtonClick,
+        onNegativeButtonClick = {}, // No negative button option for IronFox preferences.
+        shouldShowElevation = shouldShowElevation,
+    )
+
+    OnboardingPageUiData.Type.IF_PREFERENCES -> createOnboardingPageState(
+        onboardingPageUiData = onboardingPageUiData,
+        onPositiveButtonClick = onIfPreferencesButtonClick,
+        onNegativeButtonClick = {}, // No negative button option for IronFox preferences.
+        shouldShowElevation = shouldShowElevation,
+    )
 }
 
 private fun createOnboardingPageState(
@@ -276,5 +317,6 @@ private fun createOnboardingPageState(
     toolbarOptions = onboardingPageUiData.toolbarOptions,
     termsOfService = onboardingPageUiData.termsOfService,
     marketingData = onboardingPageUiData.marketingData,
+    ifPreferenceOptions = onboardingPageUiData.ifPreferencesData,
     shouldShowElevation = shouldShowElevation,
 )
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageState.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageState.kt
index df9918a6241f..9813fd9b6088 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageState.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageState.kt
@@ -6,6 +6,7 @@ package org.mozilla.fenix.onboarding.view
 
 import androidx.annotation.DrawableRes
 import org.mozilla.fenix.compose.LinkTextState
+import org.mozilla.fenix.nimbus.IfPreferencesData
 
 /**
  * Model containing data for [OnboardingPage].
@@ -34,6 +35,7 @@ data class OnboardingPageState(
     val termsOfService: OnboardingTermsOfService? = null,
     val toolbarOptions: List<ToolbarOption>? = null,
     val marketingData: OnboardingMarketingData? = null,
+    val ifPreferenceOptions: List<IfPreferenceOption>? = null,
     val onRecordImpressionEvent: () -> Unit = {},
     val shouldShowElevation: Boolean = true,
 )
@@ -109,6 +111,21 @@ enum class ThemeOptionType(val id: String) {
     THEME_SYSTEM("theme_system"),
 }
 
+data class IfPreferenceOption(
+    val label: String,
+    val caption: String,
+    val description: String,
+    val preferenceType: IfPreferenceType,
+)
+
+enum class IfPreferenceType(val id: String) {
+    DEFAULT("default"),
+    JS_JIT("js_jit"),
+    SAFE_BROWSING("safe_browsing"),
+    SPOOF_ENGLISH("spoof_english"),
+    INSTALL_UBLOCK("install_ublock"),
+}
+
 /**
  * Model containing data for the terms of service page during onboarding.
  */
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageUiData.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageUiData.kt
index 6625e28ee5c9..f8aa6816d77a 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageUiData.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingPageUiData.kt
@@ -22,6 +22,7 @@ data class OnboardingPageUiData(
     val themeOptions: List<ThemeOption>? = null,
     val termsOfService: OnboardingTermsOfService? = null,
     val marketingData: OnboardingMarketingData? = null,
+    val ifPreferencesData: List<IfPreferenceOption>? = null
 ) {
     /**
      * Model for different types of Onboarding Pages.
@@ -55,6 +56,12 @@ data class OnboardingPageUiData(
         MARKETING_DATA(
             telemetryId = "marketing_data",
         ),
+        IF_PREFERENCE_DOH(
+            telemetryId = "if_preference_doh",
+        ),
+        IF_PREFERENCES(
+            telemetryId = "if_preferences",
+        ),
     }
 }
 
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingScreen.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingScreen.kt
index 586b9d487f85..23ef69aa682b 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingScreen.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/onboarding/view/OnboardingScreen.kt
@@ -216,6 +216,12 @@ fun OnboardingScreen(
             onMarketingDataContinueClick(allowMarketingDataCollection)
             scrollToNextPageOrDismiss()
         },
+        onIfPreferenceDohButtonClick = {
+            scrollToNextPageOrDismiss()
+        },
+        onIfPreferencesButtonClick = {
+            scrollToNextPageOrDismiss()
+        },
         onboardingStore = onboardingStore,
     )
 }
@@ -263,6 +269,8 @@ private fun OnboardingContent(
     onMarketingOptInToggle: (optIn: Boolean) -> Unit,
     onMarketingDataLearnMoreClick: () -> Unit,
     onMarketingDataContinueClick: (allowMarketingDataCollection: Boolean) -> Unit,
+    onIfPreferenceDohButtonClick: () -> Unit,
+    onIfPreferencesButtonClick: () -> Unit,
 ) {
     val nestedScrollConnection = remember { DisableForwardSwipeNestedScrollConnection(pagerState) }
 
@@ -294,6 +302,8 @@ private fun OnboardingContent(
                     onCustomizeToolbarButtonClick = onCustomizeToolbarButtonClick,
                     onCustomizeThemeClick = onCustomizeThemeButtonClick,
                     onTermsOfServiceButtonClick = onAgreeAndConfirmTermsOfService,
+                    onIfPreferenceDohButtonClick = onIfPreferenceDohButtonClick,
+                    onIfPreferencesButtonClick = onIfPreferencesButtonClick,
                     shouldShowElevation = false,
                 )
                 OnboardingPageForType(
@@ -385,6 +395,14 @@ private fun OnboardingPageForType(
             state,
             termsOfServiceEventHandler,
         )
+
+        OnboardingPageUiData.Type.IF_PREFERENCE_DOH -> IronFoxPreferenceDohOnboardingPage(
+            pageState = state,
+        )
+
+        OnboardingPageUiData.Type.IF_PREFERENCES -> IronFoxPreferencesOnboardingPage(
+            pageState = state,
+        )
     }
 }
 
@@ -434,6 +452,8 @@ private fun OnboardingScreenPreview() {
             onMarketingDataLearnMoreClick = {},
             onMarketingOptInToggle = {},
             onMarketingDataContinueClick = {},
+            onIfPreferenceDohButtonClick = {},
+            onIfPreferencesButtonClick = {},
         )
     }
 }
diff --git a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/settings/doh/root/DohSettingsScreen.kt b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/settings/doh/root/DohSettingsScreen.kt
index a8299a9eafe9..83ec862a6b2b 100644
--- a/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/settings/doh/root/DohSettingsScreen.kt
+++ b/mobile/android/fenix/app/src/main/java/org/mozilla/fenix/settings/doh/root/DohSettingsScreen.kt
@@ -437,7 +437,7 @@ private fun buildProviderMenuItems(
 }
 
 @Composable
-private fun AlertDialogAddCustomProvider(
+internal fun AlertDialogAddCustomProvider(
     customProviderUrl: String,
     customProviderErrorState: CustomProviderErrorState,
     onCustomCancelClicked: () -> Unit,
-- 
2.53.0

